Name: faf
Version: @PACKAGE_VERSION@
Release: 1%{?dist}
Summary: Analysis framework for Fedora
Group: Development/Libraries
License: GPLv3+
Source0: https://fedorahosted.org/released/faf/faf-%{version}.tar.xz
# faf-cache
Requires: MySQL-python
BuildRequires: MySQL-python mysql-server
# faf-btserver
Requires: btparser >= 0:0.15
BuildRequires: btparser >= 0:0.15
# faf-chroot
Requires: rpm-build
# faf-debuginfo-analyze-build
Requires: elfutils
# faf-dwarf-files
BuildRequires: elfutils-devel
# faf-koji-pull-rpms, faf-chroot
Requires: rpm-python yum
BuildRequires: rpm-python yum
# Manpages
BuildRequires: asciidoc xmlto
# Python files
BuildRequires: python2-devel
# make check
BuildRequires: pylint
# libsolv
Requires: python-solv
BuildRequires: python-solv

%description
Faf is a programmable platform for analysis of packages, packaging
issues, bug reports and other artifacts produced within Fedora
operating system development.

%package kobo-hub
Summary: Kobo hub for %{name} tasks
Group: System Environment/Libraries
Requires: %{name} = %{version}
Requires: httpd
Requires: kobo-client
Requires: kobo-django
Requires: kobo-hub
BuildArch: noarch

%description kobo-hub
Kobo hub for %{name} tasks

%package kobo-worker
Summary: Kobo worker for %{name} tasks
Group: System Environment/Libraries
Requires: %{name} = %{version}
Requires: kobo-client
Requires: kobo-worker
BuildArch: noarch

%description kobo-worker
Kobo worker for %{name} tasks

%package kobo-client
Summary: Kobo client for %{name} tasks
Group: System Environment/Libraries
Requires: %{name} = %{version}
Requires: kobo-client
BuildArch: noarch

%description kobo-client
Kobo client for %{name} tasks

%prep
%setup -q

%build
%configure
make %{?_smp_mflags}

%install
make install DESTDIR=%{buildroot}

install -d -m 2775 %{buildroot}%{_localstatedir}/lib/faf
touch %{buildroot}%{_localstatedir}/lib/faf/hub.db

mkdir -p %{buildroot}%{_datadir}/%{name}/hub/tasks
mkdir -p %{buildroot}%{_localstatedir}/spool/faf
mkdir -p %{buildroot}%{_localstatedir}/log/faf/build

%check
make check

%pre
# http://fedoraproject.org/wiki/Packaging:UsersAndGroups
getent group faf >/dev/null || groupadd --system faf
getent passwd faf >/dev/null || useradd --system -g faf -d /etc/faf -s /sbin/nologin -c "Helper user for faf (analysis framework for Fedora) tools" faf
exit 0

%post
%define crontab_entry_1 "#0 0,12 * * * faf-bugzilla-pull-bugs --abrt-only --with-comments --with-attachments -v >> /var/log/faf/bugzilla-cron.log 2>&1"
%define crontab_entry_2 "#0 3 * * 6 (faf-koji-pull-tags fedora -v && faf-koji-pull-builds --only-missing fedora dist-rawhide -v && faf-koji-pull-rpms --only-missing fedora -v) >> /var/log/faf/koji-cron.log 2>&1"
if [ "$1" = 1 ]
then
# add disabled crontab entries
    ( crontab -u faf -l 2> /dev/null; echo %{crontab_entry_1}; echo %{crontab_entry_2} ) | crontab -u faf - 2> /dev/null
fi

%post kobo-hub
if [ "$1" = 1 ]
then
# "\041" = "!" - exclude it to be safely used as sed separator
# "\042" = '"' - exclude
    RANDOM_STR=`tr -c -d '[\043-\176]' < /dev/urandom | head -c 50`
    sed -i -e "s!@RANDOM_STRING@!$RANDOM_STR!g" %{_datadir}/%{name}/hub/settings.py

    LOGFILE=%{_localstatedir}/log/%{name}/syncdb_output.log
    date >> $LOGFILE
    /usr/bin/python %{_datadir}/%{name}/hub/manage.py syncdb --noinput >> $LOGFILE 2>&1
fi

%preun
if [ "$1" = 0 ]
then
# comment out all crontab entries
    ( crontab -u faf -l 2> /dev/null | sed "s,^\([^#].*\)$,#\1,g" ) | crontab -u faf - 2> /dev/null
fi

%files
%dir %{_sysconfdir}/faf
%config(noreplace) %{_sysconfdir}/faf/config
%config(noreplace) %{_sysconfdir}/httpd/conf.d/faf.conf
%dir %attr(0770, faf, faf) %{_localstatedir}/spool/faf
%dir %attr(0775, faf, faf) %{_localstatedir}/log/faf
%dir %attr(0775, faf, faf) %{_localstatedir}/log/faf/build
%dir %attr(2775, root, faf) %{_localstatedir}/lib/faf
%dir %{_datadir}/faf
%dir %{_datadir}/faf/wrappers
%{_bindir}/faf-abrt-backtraces
%{_bindir}/faf-abrt-check-reports
%{_bindir}/faf-abrt-dup-bugs
%{_bindir}/faf-abrt-dup-improvements
%{_bindir}/faf-bugzilla
%{_bindir}/faf-bugzilla-pull-attachments
%{_bindir}/faf-bugzilla-pull-bugs
%{_bindir}/faf-bugzilla-pull-comments
%{_bindir}/faf-bugzilla-pull-users
%{_bindir}/faf-btserver-cgi
%{_bindir}/faf-btserver-cluster
%{_bindir}/faf-btserver-commit-actions-bugzilla
%{_bindir}/faf-btserver-create-optimized-backtraces
%{_bindir}/faf-btserver-distance
%{_bindir}/faf-btserver-func-stats
%{_bindir}/faf-btserver-prepare-actions
%{_bindir}/faf-btserver-print-actions
%{_bindir}/faf-cache
%{_bindir}/faf-chroot
%attr(04750,root,faf) %{_bindir}/faf-chroot-helper
%{_bindir}/faf-config
%{_bindir}/faf-debuginfo-analyze-build
%{_bindir}/faf-debuginfo-analyze-builds
%{_bindir}/faf-debuginfo-build-debugsources
%{_bindir}/faf-debuginfo-report-bugzilla
%{_bindir}/faf-debuginfo-report-log
%{_bindir}/faf-dwarf-files
%{_bindir}/faf-fedora-pkgdb
%{_bindir}/faf-fedora-pkgdb-pull-collections
%{_bindir}/faf-fedora-pkgdb-pull-packages
%{_bindir}/faf-funfin-analyze-binary
%{_bindir}/faf-funfin-analyze-build
%{_bindir}/faf-funfin-analyze-builds
%{_bindir}/faf-funfin-report
%{_bindir}/faf-koji
%{_bindir}/faf-koji-pull-builds
%{_bindir}/faf-koji-pull-rpms
%{_bindir}/faf-koji-pull-tags
%{_bindir}/faf-llvm-build
%{_bindir}/faf-refreshrepo
%{_bindir}/faf-stats-abrt-bugs-closed
%{_bindir}/faf-stats-abrt-bugs-opened
%{_bindir}/faf-stats-abrt-bugs-remaining-opened
%{_bindir}/faf-stats-abrt-crashes
%{_bindir}/faf-stats-abrt-development
%{_bindir}/faf-stats-abrt-users
%{_mandir}/man1/faf-*.1.gz
%{_datadir}/faf/*.html
%{_datadir}/faf/wrappers/*
%{python_sitelib}/pyfaf


%files kobo-hub
%dir %attr(0755,faf,faf) %{_datadir}/%{name}/hub
%dir %attr(0755,faf,faf) %{_datadir}/%{name}/hub/templates
%dir %attr(0775,faf,apache) %{_datadir}/%{name}/hub/tasks
%dir %attr(0755,faf,faf) %{_datadir}/%{name}/hub/xmlrpc
%config(noreplace) %{_sysconfdir}/httpd/conf.d/%{name}-hub.conf
%attr(0664,faf,apache) %{_localstatedir}/lib/faf/hub.db
%{_datadir}/%{name}/hub/hub.wsgi
%{_datadir}/%{name}/hub/*.py
%{_datadir}/%{name}/hub/*.pyc
%{_datadir}/%{name}/hub/*.pyo
%{_datadir}/%{name}/hub/templates/*.html
%{_datadir}/%{name}/hub/xmlrpc/*.py
%{_datadir}/%{name}/hub/xmlrpc/*.pyc
%{_datadir}/%{name}/hub/xmlrpc/*.pyo

%files kobo-worker
%dir %attr(0755,faf,faf) %{_datadir}/%{name}/worker
%dir %attr(0755,faf,faf) %{_datadir}/%{name}/worker/tasks
%config(noreplace) %{_sysconfdir}/%{name}/worker.conf
%{_datadir}/%{name}/worker/worker
%{_datadir}/%{name}/worker/*.py
%{_datadir}/%{name}/worker/*.pyc
%{_datadir}/%{name}/worker/*.pyo
%{_datadir}/%{name}/worker/tasks/*.py
%{_datadir}/%{name}/worker/tasks/*.pyc
%{_datadir}/%{name}/worker/tasks/*.pyo

%files kobo-client
%dir %attr(0755,faf,faf) %{_datadir}/%{name}/client
%dir %attr(0755,faf,faf) %{_datadir}/%{name}/client/commands
%config(noreplace) %{_sysconfdir}/%{name}/client.conf
%{_datadir}/%{name}/client/client
%{_datadir}/%{name}/client/*.py
%{_datadir}/%{name}/client/*.pyc
%{_datadir}/%{name}/client/*.pyo
%{_datadir}/%{name}/client/commands/*.py
%{_datadir}/%{name}/client/commands/*.pyc
%{_datadir}/%{name}/client/commands/*.pyo

%changelog
* Mon Aug 30 2010 Karel Klic <kklic@redhat.com> @PACKAGE_VERSION@-1
- Upstream package spec file
