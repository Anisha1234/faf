#!/usr/bin/python
# Test local cache implementation, including the
# command line client faf-cache.
import unittest2 as unittest
import tempfile
import shutil
import subprocess
import os
import sys
import datetime
import urllib
sys.path.insert(0, os.path.abspath(".."))
os.environ["PATH"] = "{0}:{1}".format(os.path.abspath(".."), os.environ["PATH"])
import pyfaf

with open("backtrace.valid", "r") as f:
    bt_valid = f.read()
REQUEST_VALID = "component=coreutils&backtrace={0}".format(urllib.quote_plus(bt_valid))

with open("backtrace.unknown", "r") as f:
    bt_unknown = f.read()
REQUEST_UNKNOWN = "component=xterm&backtrace={0}".format(urllib.quote_plus(bt_unknown))

with open("backtrace.invalid", "r") as f:
    bt_invalid = f.read()
REQUEST_INVALID = "component=coreutils&backtrace={0}".format(urllib.quote_plus(bt_invalid))

class TestCase(unittest.TestCase):
    USER = """Id: 1
Email: test@test.com
CanLogin: True
Name: testuser
RealName: Test User
"""
    COMMENTS = [
"""Id: 1
BugId: 1
AuthorId: 1
Number: 1
IsPrivate: False
Body:
  Just a testing comment
Time: 2006-04-22T00:52:44.000000
Type: NORMAL
""",
"""Id: 2
BugId: 2
AuthorId: 1
Number: 1
IsPrivate: False
Body:
  Just a testing comment
Time: 2006-04-22T00:52:44.000000
Type: NORMAL
""",
"""Id: 3
BugId: 3
AuthorId: 1
Number: 1
IsPrivate: False
Body:
  Just a testing comment
Time: 2006-04-22T00:52:44.000000
Type: NORMAL
""",
"""Id: 4
BugId: 4
AuthorId: 1
Number: 1
IsPrivate: False
Body:
  Just a testing comment
Time: 2006-04-22T00:52:44.000000
Type: NORMAL
""",
"""Id: 5
BugId: 5
AuthorId: 1
Number: 1
IsPrivate: False
Body:
  Just a testing comment
Time: 2006-04-22T00:52:44.000000
Type: NORMAL
""" ]
    BUGS = [
"""Id: 1
Summary: [abrt] coreutils-8.10-2.fc15: __nanosleep_nocancel: Process /bin/sleep was killed by signal 11 (SIGSEGV)
Status: CLOSED
Resolution: NOTABUG
CreationTime: 2011-03-31T11:50:00.000000
LastChangeTime: 2011-03-31T11:57:25.000000
Product: Fedora
ProductVersion: 15
Component: coreutils
Whiteboard: abrt_hash:9d64e99e016766e4827bd6381b9f67bf2461b50e
CreatorId: 1
Comments: 1
Attachments: 1
""",
"""Id: 2
Summary: [abrt] crash in coreutils-7.6-11.fc12: __nanosleep_nocancel: Process /bin/sleep was killed by signal 11 (SIGSEGV)
Status: CLOSED
Resolution: NOTABUG
CreationTime: 2010-06-22T18:02:00.000000
LastChangeTime: 2010-06-22T18:03:14.000000
Product: Fedora
ProductVersion: 12
Component: coreutils
Whiteboard: abrt_hash:34e4297238e81b0ae337c0e80512825e9fa15597
CreatorId: 1
Comments: 2
Attachments: 2
""",
"""Id: 3
Summary: [abrt] crash in coreutils-7.6-11.fc12: __nanosleep_nocancel: Process /bin/sleep was killed by signal 11 (SIGSEGV)
Status: NEW
CreationTime: 2010-06-22T17:56:00.000000
LastChangeTime: 2010-09-08T11:55:08.000000
Product: Fedora
ProductVersion: 12
Component: coreutils
Whiteboard: abrt_hash:0323adaa33103a28f723a4ce63c791f9640c0dbd
CreatorId: 1
Comments: 3
Attachments: 3
""",
"""Id: 4
Summary: [abrt] crash in coreutils-8.4-1.el6: Process /bin/sleep was killed by signal 11 (SIGSEGV)
Status: CLOSED
Resolution: NOTABUG
CreationTime: 2010-04-07T11:28:00.000000
LastChangeTime: 2010-04-07T11:33:22.000000
Product: Red Hat Enterprise Linux 6
ProductVersion: 6.0
Component: coreutils
Whiteboard: abrt_hash:49ac88b654ef1d628d6146365950b383a1e68d5a
CreatorId: 1
Comments: 4
Attachments: 4
""",
"""Id: 5
Summary: [abrt] crash detected in coreutils-7.6-5.fc12
Status: ASSIGNED
CreationTime: 2009-10-08T10:30:00.000000
LastChangeTime: 2009-10-08T10:31:59.000000
Product: Fedora
ProductVersion: rawhide
Component: coreutils
Whiteboard: abrt_hash:5933d38ad6db27fee9c92863b66a4d5f013a202a
CreatorId: 1
Comments: 5
Attachments: 5
""" ]
    ATTACHMENTS = [ """Id: 1
BugId: 1
UserId: 1
MimeType: text/plain
Description:
  File: backtrace
CreationTime: 2011-03-31T07:50:00.000000
LastChangeTime: 2011-03-31T07:50:33.000000
IsPrivate: False
IsPatch: False
IsObsolete: False
FileName: backtrace
Contents:
  [New LWP 3123]
  Core was generated by `/bin/sleep 5m'.
  Program terminated with signal 11, Segmentation fault.
  #0  __kernel_vsyscall () at arch/x86/vdso/vdso32/int80.S:16
  16	arch/x86/vdso/vdso32/int80.S: No such file or directory.
  	in arch/x86/vdso/vdso32/int80.S
  
  Thread 1 (LWP 3123):
  #0  __kernel_vsyscall () at arch/x86/vdso/vdso32/int80.S:16
  No locals.
  #1  0x001c2000 in __nanosleep_nocancel () at ../sysdeps/unix/syscall-templa=
  te.S:82
  No locals.
  #2  0x0804b242 in xnanosleep (seconds=3D300) at xnanosleep.c:111
          overflow =3D false
          ts_sleep =3D {tv_sec =3D 300, tv_nsec =3D 0}
          __PRETTY_FUNCTION__ =3D "xnanosleep"
  #3  0x08048f49 in main (argc=3D2, argv=3D0xbfce95b4) at sleep.c:147
          i =3D 2
          seconds =3D <optimized out>
          ok =3D <optimized out>
  From        To          Syms Read   Shared Object Library
  0x00136c00  0x002540b4  Yes         /lib/libc.so.6
  0x00878850  0x008907ff  Yes         /lib/ld-linux.so.2
  $1 =3D 0x0
  No symbol "__glib_assert_msg" in current context.
  eax            0xfffffdfc	-516
  ecx            0x0	0
  edx            0x804e4c8	134538440
  ebx            0xbfce9478	-1076980616
  esp            0xbfce9448	0xbfce9448
  ebp            0xbfce9478	0xbfce9478
  esi            0xb7808688	-1216313720
  edi            0x0	0
  eip            0x9c3416	0x9c3416 <__kernel_vsyscall+2>
  eflags         0x200246	[ PF ZF IF ID ]
  cs             0x73	115
  ss             0x7b	123
  ds             0x7b	123
  es             0x7b	123
  fs             0x0	0
  gs             0x33	51
  Dump of assembler code for function __kernel_vsyscall:
     0x009c3414 <+0>:	int    $0x80
  =3D> 0x009c3416 <+2>:	ret   =20
  End of assembler dump.""",
"""Id: 2
BugId: 2
UserId: 1
MimeType: text/plain
Description:
  File: backtrace
CreationTime: 2010-06-22T14:02:00.000000
LastChangeTime: 2010-06-22T14:02:42.000000
IsPrivate: False
IsPatch: False
IsObsolete: False
FileName: backtrace
Contents:
  Core was generated by `sleep 10000'.
  Program terminated with signal 11, Segmentation fault.
  #0  0x00820416 in __kernel_vsyscall ()
  
  Thread 1 (Thread 5871):
  #0  0x00820416 in __kernel_vsyscall ()
  No symbol table info available.
  #1  0x004d0dd0 in __nanosleep_nocancel ()
      at ../sysdeps/unix/syscall-template.S:82
  No locals.
  #2  0x0804b1dc in xnanosleep (seconds=3D10000) at xnanosleep.c:112
          overflow =3D false
          ts_sleep =3D {tv_sec =3D 10000, tv_nsec =3D 0}
          __PRETTY_FUNCTION__ =3D "xnanosleep"
  #3  0x080491ee in main (argc=3D2, argv=3D0xbfd624e4) at sleep.c:147
          i =3D 2
          seconds =3D <value optimized out>
          ok =3D <value optimized out>
  From        To          Syms Read   Shared Object Library
  0x0044b990  0x005578a0  Yes (*)     /lib/libc.so.6
  0x00413830  0x0042acdf  Yes (*)     /lib/ld-linux.so.2
  (*): Shared library is missing debugging information.
  $1 =3D 0x0
  No symbol "__glib_assert_msg" in current context.
  eax            0xfffffdfc	-516
  ecx            0x0	0
  edx            0x804e524	134538532
  ebx            0xbfd62398	-1076485224
  esp            0xbfd62368	0xbfd62368
  ebp            0xbfd623b8	0xbfd623b8
  esi            0xb7771688	-1216932216
  edi            0x0	0
  eip            0x820416	0x820416 <__kernel_vsyscall+2>
  eflags         0x246	[ PF ZF IF ]
  cs             0x73	115
  ss             0x7b	123
  ds             0x7b	123
  es             0x7b	123
  fs             0x0	0
  gs             0x33	51
  Dump of assembler code for function __kernel_vsyscall:
  0x00820414 <__kernel_vsyscall+0>:	int    $0x80
  0x00820416 <__kernel_vsyscall+2>:	ret   =20
  End of assembler dump.""",
"""Id: 3
BugId: 3
UserId: 1
MimeType: text/plain
Description:
  File: backtrace
CreationTime: 2010-06-22T13:56:00.000000
LastChangeTime: 2010-06-22T13:56:48.000000
IsPrivate: False
IsPatch: False
IsObsolete: False
FileName: backtrace
Contents:
  Core was generated by `sleep 1000'.
  Program terminated with signal 11, Segmentation fault.
  #0  0x0077b416 in __kernel_vsyscall ()
  
  Thread 1 (Thread 5623):
  #0  0x0077b416 in __kernel_vsyscall ()
  No symbol table info available.
  #1  0x004d0dd0 in __nanosleep_nocancel ()
      at ../sysdeps/unix/syscall-template.S:82
  No locals.
  #2  0x0804b1dc in xnanosleep (seconds=3D1000) at xnanosleep.c:112
          overflow =3D false
          ts_sleep =3D {tv_sec =3D 1000, tv_nsec =3D 0}
          __PRETTY_FUNCTION__ =3D "xnanosleep"
  #3  0x080491ee in main (argc=3D2, argv=3D0xbfff3854) at sleep.c:147
          i =3D 2
          seconds =3D <value optimized out>
          ok =3D <value optimized out>
  From        To          Syms Read   Shared Object Library
  0x0044b990  0x005578a0  Yes (*)     /lib/libc.so.6
  0x00413830  0x0042acdf  Yes (*)     /lib/ld-linux.so.2
  (*): Shared library is missing debugging information.
  $1 =3D 0x0
  No symbol "__glib_assert_msg" in current context.
  eax            0xfffffdfc	-516
  ecx            0x0	0
  edx            0x804e524	134538532
  ebx            0xbfff3708	-1073793272
  esp            0xbfff36d8	0xbfff36d8
  ebp            0xbfff3728	0xbfff3728
  esi            0xb7739688	-1217161592
  edi            0x0	0
  eip            0x77b416	0x77b416 <__kernel_vsyscall+2>
  eflags         0x246	[ PF ZF IF ]
  cs             0x73	115
  ss             0x7b	123
  ds             0x7b	123
  es             0x7b	123
  fs             0x0	0
  gs             0x33	51
  Dump of assembler code for function __kernel_vsyscall:
  0x0077b414 <__kernel_vsyscall+0>:	int    $0x80
  0x0077b416 <__kernel_vsyscall+2>:	ret   =20
  End of assembler dump.""",
"""Id: 4
BugId: 4
UserId: 1
MimeType: text/plain
Description:
  File: backtrace
CreationTime: 2010-04-07T07:28:00.000000
LastChangeTime: 2010-04-07T07:28:37.000000
IsPrivate: False
IsPatch: False
IsObsolete: False
FileName: backtrace
Contents:
  warning: Unable to open "librpm.so.0" (librpm.so.0: cannot open shared obje=
  ct file: No such file or directory), missing debuginfos notifications will =
  not be displayed
  Missing separate debuginfo for /lib/libc.so.6
  Try: yum --enablerepo=3D'*-debuginfo' install /usr/lib/debug/.build-id/17/d=
  89a6eaad5d4b98f7ac899e1afb896c0b53ad7 /var/cache/abrt-di/usr/lib/debug/.bui=
  ld-id/17/d89a6eaad5d4b98f7ac899e1afb896c0b53ad7
  Missing separate debuginfo for /lib/ld-linux.so.2
  Try: yum --enablerepo=3D'*-debuginfo' install /usr/lib/debug/.build-id/83/0=
  f3a1f788f031f6d180759de5c040d315e70a2 /var/cache/abrt-di/usr/lib/debug/.bui=
  ld-id/83/0f3a1f788f031f6d180759de5c040d315e70a2
  Missing separate debuginfo for=20
  Try: yum --enablerepo=3D'*-debuginfo' install /usr/lib/debug/.build-id/3f/6=
  19488bb1978a1f66c01be43a56197f19ad8e4 /var/cache/abrt-di/usr/lib/debug/.bui=
  ld-id/3f/619488bb1978a1f66c01be43a56197f19ad8e4
  Core was generated by `sleep 1000'.
  Program terminated with signal 11, Segmentation fault.
  #0  0x001f1424 in __kernel_vsyscall ()
  
  Thread 1 (Thread 8263):
  #0  0x001f1424 in __kernel_vsyscall ()
  No symbol table info available.
  #1  0x00dfaf90 in __nanosleep_nocancel ()
      at ../sysdeps/unix/syscall-template.S:82
  No locals.
  #2  0x0804b1ac in xnanosleep (seconds=3D<value optimized out>)
      at xnanosleep.c:111
          overflow =3D false
          ts_sleep =3D {tv_sec =3D 1000, tv_nsec =3D 0}
          __PRETTY_FUNCTION__ =3D "xnanosleep"
  #3  0x0804927e in main (argc=3D<value optimized out>,=20
      argv=3D<value optimized out>) at sleep.c:147
          i =3D 2
          seconds =3D <value optimized out>
          ok =3D <value optimized out>
  From        To          Syms Read   Shared Object Library
  0x00d75990  0x00e8b134  Yes (*)     /lib/libc.so.6
  0x00f71830  0x00f88d0f  Yes (*)     /lib/ld-linux.so.2
  (*): Shared library is missing debugging information.
  $1 =3D 0x0
  No symbol "__glib_assert_msg" in current context.""",
"""Id: 5
BugId: 5
UserId: 1
MimeType: text/plain
Description:
  File: backtrace
CreationTime: 2009-10-08T06:30:00.000000
LastChangeTime: 2009-10-08T06:30:55.000000
IsPrivate: False
IsPatch: False
IsObsolete: False
FileName: backtrace
Contents:
  Core was generated by `sleep 1000'.
  Program terminated with signal 11, Segmentation fault.
  #0  0x00c51416 in __kernel_vsyscall ()
  
  Thread 1 (Thread 2116):
  #0  0x00c51416 in __kernel_vsyscall ()
  No symbol table info available.
  #1  0x00307c40 in __nanosleep_nocancel ()
      at ../sysdeps/unix/syscall-template.S:82
  No locals.
  #2  0x0804b1dc in xnanosleep (seconds=3D<value optimized out>)
      at xnanosleep.c:112
          overflow =3D false
          ts_sleep =3D {tv_sec =3D 1000, tv_nsec =3D 0}
          __PRETTY_FUNCTION__ =3D "xnanosleep"
  #3  0x080491ee in main (argc=3D<value optimized out>, argv=3D<value optimiz=
  ed out>)
      at sleep.c:147
          i =3D 2
          seconds =3D <value optimized out>
          ok =3D <value optimized out>""" ]

    BUILDS = [ """Id: 1
Name: coreutils
Version: 8.10
Release: 2.fc15
Epoch: 0
TaskId: 1
CreationTime: 2009-07-28T05:33:09.295849
CompletionTime: 2009-07-28T06:16:57.510430
Tags: dist-f15
RPMs: 1, 2
""", ]
    RPMS = [ """Id: 1
BuildId: 1
Name: coreutils
Version: 8.10
Release: 2.fc15
Epoch: 0
Architecture: i686
Size: 138891
Files:
- /bin/sleep
Provides:
- Name: coreutils(x86-32)
  Flags: 8
  Epoch: 0
  Version: 8.10
  Release: 2.fc15
Requires:
- Name: coreutils-libs
  Flags: 8
  Epoch: 0
  Version: 8.10
  Release: 2.fc15
""",
"""Id: 2
BuildId: 1
Name: coreutils-libs
Version: 8.10
Release: 2.fc15
Epoch: 0
Architecture: i686
Size: 47628
Files:
- /usr/lib/coreutils
- /usr/lib/coreutils/libstdbuf.so
Provides:
- Name: libstdbuf.so
  Flags: 32768
- Name: coreutils-libs
  Flags: 8
  Epoch: 0
  Version: 8.10
  Release: 2.fc15
- Name: coreutils-libs(x86-32)
  Flags: 8
  Epoch: 0
  Version: 8.10
  Release: 2.fc15
Requires:
- Name: coreutils
  Flags: 8
  Epoch: 0
  Version: 8.10
  Release: 2.fc15
""" ]

    def _cache_popen(self, args, stdin=None):
        args = ["faf-cache", "--cache-dir", self.cache_dir, "--db-type", "sqlite3"] + args
        return subprocess.Popen(args, stdout=subprocess.PIPE, stdin=stdin, stderr=subprocess.PIPE)

    def _create_user(self):
        # Test that add works with right parameters
        proc = self._cache_popen(args=["add", "rhbz-user", str(1)], stdin=subprocess.PIPE)
        stdout, stderr = proc.communicate(self.USER)
        self.assertEqual(stdout, "")
        self.assertEqual(stderr, "")
        self.assertEqual(proc.returncode, 0)

    def _create_bugs(self):
        i = 1
        for bug in self.BUGS:
            proc = self._cache_popen(["add", "rhbz-bug", str(i)], stdin=subprocess.PIPE)
            stdout, stderr = proc.communicate(bug)
            self.assertEqual(stdout, "")
            self.assertEqual(stderr, "")
            self.assertEqual(proc.returncode, 0)
            i += 1

    def _create_attachments(self):
        i = 1
        for att in self.ATTACHMENTS:
            proc = self._cache_popen(["add", "rhbz-attachment", str(i)], stdin=subprocess.PIPE)
            stdout, stderr = proc.communicate(att)
            self.assertEqual(stdout, "")
            self.assertEqual(stderr, "")
            self.assertEqual(proc.returncode, 0)
            i += 1

    def _create_comments(self):
        i = 1
        for cmnt in self.COMMENTS:
            proc = self._cache_popen(["add", "rhbz-comment", str(i)], stdin=subprocess.PIPE)
            stdout, stderr = proc.communicate(cmnt)
            self.assertEqual(stdout, "")
            self.assertEqual(stderr, "")
            self.assertEqual(proc.returncode, 0)
            i += 1

    def _create_builds(self):
        i = 1
        for build in self.BUILDS:
            proc = self._cache_popen(["add", "fedora-koji-build", str(i)], stdin=subprocess.PIPE)
            stdout, stderr = proc.communicate(build)
            self.assertEqual(stdout, "")
            self.assertEqual(stderr, "")
            self.assertEqual(proc.returncode, 0)
            i += 1

    def _create_rpms(self):
        i = 1
        for rpm in self.RPMS:
            proc = self._cache_popen(["add", "fedora-koji-rpm", str(i)], stdin=subprocess.PIPE)
            stdout, stderr = proc.communicate(rpm)
            self.assertEqual(stdout, "")
            self.assertEqual(stderr, "")
            self.assertEqual(proc.returncode, 0)
            i += 1

    def _create_config(self):
        with tempfile.NamedTemporaryFile(prefix="faf-test-config", mode="w", delete=False) as cfgfile:
            cfgfile.write("""[Cache]
Directory={0}
DbType=sqlite3
""".format(self.cache_dir))
        self.config_file = cfgfile.name
        os.putenv("FAF_CONFIG_FILE", self.config_file)

    def setUp(self):
        self.cache_dir = tempfile.mkdtemp(prefix="faf-cache-test")
        self._create_config()
        self._create_user()
        self._create_bugs()
        self._create_attachments()
        self._create_comments()
        self._create_builds()
        self._create_rpms()
        retcode = subprocess.call(["faf-btserver-create-optimized-backtraces"])
        self.assertEqual(retcode, 0)
        os.putenv("REQUEST_METHOD", "POST")

    def tearDown(self):
        shutil.rmtree(self.cache_dir)
        os.unlink(self.config_file)
        os.unsetenv("REQUEST_METHOD")
        os.unsetenv("HTTP_ACCEPT")
        os.unsetenv("SCRIPT_NAME")
        os.unsetenv("HTTP_HOST")

# Test command-line functionality
class Interface(TestCase):
    def test_machine_valid(self):
        proc = subprocess.Popen(["faf-btserver-cgi"], stdin=subprocess.PIPE,
                                stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        stdout, stderr = proc.communicate(REQUEST_VALID)
        self.assertEqual(proc.returncode, 0)
        self.assertEqual(stdout, """Content-type: text/plain

SAVE DUPLICATE 5
""")

    def test_machine_unknown(self):
        os.putenv("REQUEST_METHOD", "POST")
        proc = subprocess.Popen(["faf-btserver-cgi"], stdin=subprocess.PIPE,
                                stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        stdout, stderr = proc.communicate(REQUEST_UNKNOWN)
        self.assertEqual(proc.returncode, 0)
        self.assertEqual(stdout, """Content-type: text/plain

SAVE NOTFOUND
No duplicates were found for your problem.
""")

    def test_machine_invalid(self):
        proc = subprocess.Popen(["faf-btserver-cgi"], stdin=subprocess.PIPE,
                                stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        stdout, stderr = proc.communicate(REQUEST_INVALID)
        self.assertEqual(proc.returncode, 0)
        self.assertEqual(stdout, """Content-type: text/plain

ERROR: Failed to parse backtrace.
Crash thread and crash frame can not be found.
""")

    def test_human_valid(self):
        os.putenv("HTTP_ACCEPT", "text/html")
        os.putenv("SCRIPT_NAME", "/btserver.cgi")
        os.putenv("HTTP_HOST", "localhost")
        proc = subprocess.Popen(["faf-btserver-cgi"], stdin=subprocess.PIPE,
                                stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        stdout, stderr = proc.communicate(REQUEST_VALID)
        self.assertEqual(proc.returncode, 0)
        self.assertEqual(stdout, """Content-Type: text/html
Content-Length: 588

<!DOCTYPE HTML>
<html>
  <head>
    <title>Backtrace analyzing page</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <style type="text/css">
      #ToDo
    </style>
  </head>
  <body>
    <form action="http://localhost/btserver.cgi" method="post">
      <div>Backtrace:</div>
      <div><textarea name="backtrace"></textarea></div>
      <div>Component: <input type="text" name="component" /></div>
      <div><input type="submit" value="Submit" /></div>
    </form>
    <div>
      Your problem is a duplicate of bug #5.
    </div>
  </body>
</html>
""")

    def test_human_unknown(self):
        os.putenv("HTTP_ACCEPT", "text/html")
        os.putenv("SCRIPT_NAME", "/btserver.cgi")
        os.putenv("HTTP_HOST", "localhost")
        proc = subprocess.Popen(["faf-btserver-cgi"], stdin=subprocess.PIPE,
                                stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        stdout, stderr = proc.communicate(REQUEST_UNKNOWN)
        self.assertEqual(proc.returncode, 0)
        self.assertEqual(stdout, """Content-Type: text/html
Content-Length: 592

<!DOCTYPE HTML>
<html>
  <head>
    <title>Backtrace analyzing page</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <style type="text/css">
      #ToDo
    </style>
  </head>
  <body>
    <form action="http://localhost/btserver.cgi" method="post">
      <div>Backtrace:</div>
      <div><textarea name="backtrace"></textarea></div>
      <div>Component: <input type="text" name="component" /></div>
      <div><input type="submit" value="Submit" /></div>
    </form>
    <div>
      No duplicates were found for your problem.
    </div>
  </body>
</html>
""")

    def test_human_invalid(self):
        os.putenv("HTTP_ACCEPT", "text/html")
        os.putenv("SCRIPT_NAME", "/btserver.cgi")
        os.putenv("HTTP_HOST", "localhost")
        proc = subprocess.Popen(["faf-btserver-cgi"], stdin=subprocess.PIPE,
                                stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        stdout, stderr = proc.communicate(REQUEST_INVALID)
        self.assertEqual(proc.returncode, 0)
        self.assertEqual(stdout, """Content-Type: text/html
Content-Length: 636

<!DOCTYPE HTML>
<html>
  <head>
    <title>Backtrace analyzing page</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <style type="text/css">
      #ToDo
    </style>
  </head>
  <body>
    <form action="http://localhost/btserver.cgi" method="post">
      <div>Backtrace:</div>
      <div><textarea name="backtrace"></textarea></div>
      <div>Component: <input type="text" name="component" /></div>
      <div><input type="submit" value="Submit" /></div>
    </form>
    <div>
      ERROR: Failed to parse backtrace.<br />
Crash thread and crash frame can not be found.
    </div>
  </body>
</html>
""")

if __name__ == '__main__':
    unittest.main()
