#!/usr/bin/env python
import sys
import logging
import datetime

import pyfaf

parser = pyfaf.argparse.ArgumentParser(description="Bugzilla scraper",
                                       default_log_level=1)
parser.add_argument("--create_components", help="Create missing components",
                    default=False, action="store_true")
parser.add_argument("--create_opsysreleases", help="Create missing releases",
                    default=False, action="store_true")

parser.add_argument("--from", help="Search for bugs changed since date",
                    metavar="YYYY-MM-DD")
parser.add_argument("--to", help="Search for bugs changed till date",
                    metavar="YYYY-MM-DD")

parser.add_argument("--id", help="Pull bug with specified ID",
                    metavar="ID")

parser.add_argument("--all", help="Pull non ABRT bugs",
                    default=False, action="store_true")

parser.add_argument("--update", help="Only update already downloaded bugs",
                    default=False, action="store_true")

parser.add_argument("--product", help="Download bugs for this product",
                    default="Fedora")

args = parser.parse_args()
arg_dict = vars(args)

if __name__ == "__main__":
    fmt = '%Y-%m-%d'
    kwargs = dict()

    for dtfield in ['from', 'to']:
        passed = arg_dict[dtfield]
        if passed:
            try:
                kwargs[dtfield + '_date'] = datetime.datetime.strptime(
                    passed, fmt).date()
            except ValueError:
                print('Invalid date format passed: {0}, '
                      'use YYYY-MM-DD'.format(passed))
                sys.exit(1)

    # set bugzilla log level to our current level
    bz_logger = logging.getLogger('bugzilla')
    bz_logger.setLevel(logging.getLogger().level)

    db = pyfaf.storage.getDatabase()
    bugzilla = pyfaf.bugzilla.Bugzilla(db)
    bugzilla.login()

    bugzilla.add_components = args.create_components
    bugzilla.add_opsysreleases = args.create_opsysreleases

    def process(bug):
        processed = bugzilla.process_bug(bug)
        if not processed:
            logging.error('Failed to process bug #{0}.'.format(bug.bug_id))
            return

        bugzilla.save_bug(processed)

    if args.id:
        bugzilla.save_bug(bugzilla.download_bug(args.id))
    elif args.update:
        bugzilla.update_downloaded_bugs()
    elif args.all:
        map(process, bugzilla.all_bugs(**kwargs))
    else:
        map(process, bugzilla.all_abrt_bugs(args.product, **kwargs))
